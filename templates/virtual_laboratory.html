{% extends "base.html" %}
{% block title %}–í–∏—Ä—Ç—É–µ–ª–Ω–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—ò–∞ - –°—Ç—É–¥–µ–Ω—Ç{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h2>üß™ –í–∏—Ä—Ç—É–µ–ª–Ω–∞ —Ö–µ–º–∏—Å–∫–∞ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—ò–∞</h2>
            <p class="lead">–ò–∑–±–µ—Ä–µ—Ç–µ –¥–≤–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑–∞ –¥–∞ —Å–∏–º—É–ª–∏—Ä–∞—Ç–µ —Ä–µ–∞–∫—Ü–∏—ò–∞</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg">
                <div class="card-body p-4">
                    <!-- –°–∏–º—É–ª–∞—Ü–∏—Å–∫–∞ –æ–±–ª–∞—Å—Ç -->
                    <div style="display: grid; grid-template-columns: 1fr 150px 1fr; gap: 40px; align-items: center; margin-bottom: 40px;">
                        
                        <!-- –ü—Ä–≤ –µ–ª–µ–º–µ–Ω—Ç -->
                        <div class="text-center">
                            <div id="element1-display" style="width: 130px; height: 130px; border: 3px dashed #007bff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; background: #f8f9fa; transition: all 0.3s ease;">
                                <span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 1</span>
                            </div>
                            <select class="form-select mt-3" id="element1-select" style="max-width: 200px; margin: 15px auto;">
                                <option value="">-- –ò–∑–±–µ—Ä–∏ –ø—Ä–≤ –µ–ª–µ–º–µ–Ω—Ç --</option>
                                {% for element in elements %}
                                <option value="{{ element.symbol }}" data-name="{{ element.element_name }}">
                                    {{ element.symbol }} - {{ element.element_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- –¶–µ–Ω—Ç–∞—Ä —Å–æ –∫–æ–ø—á–µ -->
                        <div class="text-center">
                            <div style="font-size: 24px; color: #28a745; font-weight: bold; margin-bottom: 15px;">+</div>
                            <button class="btn btn-success btn-lg" id="react-btn" disabled onclick="simulateReaction()" style="border-radius: 20px; padding: 12px 25px;">
                                ‚öóÔ∏è –†–µ–∞–≥–∏—Ä–∞—ò
                            </button>
                            <div style="font-size: 24px; color: #007bff; font-weight: bold; margin-top: 15px;">‚Üí</div>
                        </div>
                        
                        <!-- –í—Ç–æ—Ä –µ–ª–µ–º–µ–Ω—Ç -->
                        <div class="text-center">
                            <div id="element2-display" style="width: 130px; height: 130px; border: 3px dashed #007bff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; background: #f8f9fa; transition: all 0.3s ease;">
                                <span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 2</span>
                            </div>
                            <select class="form-select mt-3" id="element2-select" style="max-width: 200px; margin: 15px auto;">
                                <option value="">-- –ò–∑–±–µ—Ä–∏ –≤—Ç–æ—Ä –µ–ª–µ–º–µ–Ω—Ç --</option>
                                {% for element in elements %}
                                <option value="{{ element.symbol }}" data-name="{{ element.element_name }}">
                                    {{ element.symbol }} - {{ element.element_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- –†–µ–∑—É–ª—Ç–∞—Ç –æ–±–ª–∞—Å—Ç -->
                    <div id="result-area" style="display: none; margin-top: 30px;">
                        <div class="card" id="result-card">
                            <div class="card-body text-center">
                                <div id="result-content"></div>
                                
                                <!-- –ö–æ–ø—á–µ –∑–∞ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç - –°–ê–ú–û –ó–ê –°–¢–£–î–ï–ù–¢–ò -->
                                <button class="btn btn-primary mt-3" id="participate-btn" onclick="participateInExperiment()" style="display: none;">
                                    üìù –ó–∞–ø–∏—à–∏ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
                                </button>
                                
                                <div id="experiment-details" style="display: none; margin-top: 20px;">
                                    <!-- –¢—É–∫–∞ —ú–µ —Å–µ –ø—Ä–∏–∫–∞–∂–∞—Ç –¥–µ—Ç–∞–ª–∏—Ç–µ –∑–∞ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ—Ç -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4 text-center">
    <a href="/dashboard" class="btn btn-secondary">–ù–∞–∑–∞–¥ –¥–æ Dashboard</a>
    <a href="/my-experiments" class="btn btn-warning">üìä –ú–æ–∏ –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏</a>
</div>

<script>
let selectedElements = {};
let currentReactionData = null;
let currentExperimentId = null;

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('element1-select').addEventListener('change', function() {
        updateElementDisplay(this, 'element1-display', 'element1');
        checkReactionReady();
    });
    
    document.getElementById('element2-select').addEventListener('change', function() {
        updateElementDisplay(this, 'element2-display', 'element2');
        checkReactionReady();
    });
});

function updateElementDisplay(select, displayId, elementKey) {
    const display = document.getElementById(displayId);
    const value = select.value;
    const name = select.options[select.selectedIndex]?.dataset?.name || '';
    
    if (value) {
        display.innerHTML = `
            <div style="font-size: 36px; font-weight: bold; color: white;">${value}</div>
            <div style="font-size: 12px; margin-top: 5px; color: white;">${name}</div>
        `;
        display.style.borderColor = '#28a745';
        display.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
        
        selectedElements[elementKey] = { symbol: value, name: name };
    } else {
        display.innerHTML = displayId === 'element1-display' ? 
            '<span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 1</span>' : 
            '<span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 2</span>';
        display.style.borderColor = '#007bff';
        display.style.background = '#f8f9fa';
        
        delete selectedElements[elementKey];
    }
    
    // –†–µ—Å–µ—Ç–∏—Ä–∞—ò —Ä–µ–∑—É–ª—Ç–∞—Ç –∫–æ–≥–∞ —Å–µ –º–µ–Ω—É–≤–∞–∞—Ç –µ–ª–µ–º–µ–Ω—Ç–∏—Ç–µ
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('participate-btn').style.display = 'none';
}

function checkReactionReady() {
    const reactBtn = document.getElementById('react-btn');
    reactBtn.disabled = !(selectedElements.element1 && selectedElements.element2);
}

function simulateReaction() {
    if (!selectedElements.element1 || !selectedElements.element2) return;
    
    const btn = document.getElementById('react-btn');
    btn.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—É–≤–∞–º...';
    btn.disabled = true;
    
    // –ü–æ–≤–∏–∫–∞—ò API –∑–∞ —Å–∏–º—É–ª–∞—Ü–∏—ò–∞ –Ω–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞
    fetch('/api/simulate-reaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            element1: selectedElements.element1.symbol,
            element2: selectedElements.element2.symbol
        })
    })
    .then(response => response.json())
    .then(data => {
        showResult(data);
        btn.innerHTML = '‚öóÔ∏è –†–µ–∞–≥–∏—Ä–∞—ò';
        btn.disabled = false;
    })
    .catch(error => {
        console.error('–ì—Ä–µ—à–∫–∞:', error);
        btn.innerHTML = '‚öóÔ∏è –†–µ–∞–≥–∏—Ä–∞—ò';
        btn.disabled = false;
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–∏–º—É–ª–∞—Ü–∏—ò–∞ –Ω–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞—Ç–∞');
    });
}

function showResult(data) {
    const resultArea = document.getElementById('result-area');
    const resultCard = document.getElementById('result-card');
    const resultContent = document.getElementById('result-content');
    const participateBtn = document.getElementById('participate-btn');
    
    resultArea.style.display = 'block';
    
    if (data.success) {
        currentReactionData = data;
        
        // –ó–∞ —Å—Ç—É–¥–µ–Ω—Ç–∏ - –ø—Ä–∏–∫–∞–∂–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç –∏ –º–æ–∂–Ω–æ—Å—Ç –∑–∞ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
        resultCard.className = 'card border-success';
        resultContent.innerHTML = `
            <h4 class="text-success">‚úÖ –£—Å–ø–µ—à–Ω–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞!</h4>
            <div style="font-size: 24px; font-weight: bold; margin: 20px 0; color: #28a745;">
                ${selectedElements.element1.symbol} + ${selectedElements.element2.symbol} ‚Üí ${data.product}
            </div>
            <div class="row">
                <div class="col-md-6">
                    <strong>–ü—Ä–æ–¥—É–∫—Ç:</strong> ${data.product}
                </div>
                <div class="col-md-6">
                    <strong>–£—Å–ª–æ–≤–∏:</strong> ${data.conditions || '–°—Ç–∞–Ω–¥–∞—Ä–¥–Ω–∏ —É—Å–ª–æ–≤–∏'}
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <small>‚ÑπÔ∏è –ó–∞ –¥–∞ –≥–æ –∑–∞—á—É–≤–∞—Ç–µ –æ–≤–æ—ò —Ä–µ–∑—É–ª—Ç–∞—Ç, –∑–∞–ø–∏—à–µ—Ç–µ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç</small>
            </div>
        `;
        
        // –ü—Ä–∏–∫–∞–∂–∏ –∫–æ–ø—á–µ –∑–∞ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
        participateBtn.style.display = 'inline-block';
        
    } else {
        currentReactionData = null;
        resultCard.className = 'card border-warning';
        resultContent.innerHTML = `
            <h4 class="text-warning">‚ö†Ô∏è –†–µ–∞–∫—Ü–∏—ò–∞—Ç–∞ –Ω–µ –µ –¥–µ—Ñ–∏–Ω–∏—Ä–∞–Ω–∞</h4>
            <p class="mb-3">${data.message}</p>
            <div style="font-size: 18px; color: #856404; margin: 15px 0;">
                ${selectedElements.element1.symbol} + ${selectedElements.element2.symbol} ‚Üí ?
            </div>
            <div class="alert alert-warning">
                <small>–û–≤–∞–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞ —Å√® —É—à—Ç–µ –Ω–µ –µ –¥–æ–¥–∞–¥–µ–Ω–∞ –≤–æ —Å–∏—Å—Ç–µ–º–æ—Ç. –ö–æ–Ω—Ç–∞–∫—Ç–∏—Ä–∞—ò—Ç–µ –≥–æ –≤–∞—à–∏–æ—Ç –ø—Ä–æ—Ñ–µ—Å–æ—Ä.</small>
            </div>
        `;
        participateBtn.style.display = 'none';
    }
}

function participateInExperiment() {
    if (!currentReactionData) return;
    
    const participateBtn = document.getElementById('participate-btn');
    participateBtn.innerHTML = '‚è≥ –ó–∞–ø–∏—à—É–≤–∞–º...';
    participateBtn.disabled = true;
    
    // –ó–∞—á—É–≤–∞—ò —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
    fetch('/save-experiment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reaction_id: currentReactionData.reaction_id,
            result: `–°–∏–º—É–ª–∏—Ä–∞–Ω–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞: ${currentReactionData.elements} ‚Üí ${currentReactionData.product}`,
            safety_warning: '–í–∏—Ä—Ç—É–µ–ª–Ω–∞ —Å–∏–º—É–ª–∞—Ü–∏—ò–∞ - –±–µ–∑–±–µ–¥–Ω–æ –∏–∑–≤—Ä—à–µ–Ω–æ'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            participateBtn.innerHTML = '‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—à–∞–Ω–æ!';
            participateBtn.className = 'btn btn-success mt-3';
            participateBtn.disabled = true;
            
            // –ü—Ä–∏–∫–∞–∂–∏ –¥–µ—Ç–∞–ª–∏ –∑–∞ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ—Ç
            document.getElementById('experiment-details').style.display = 'block';
            document.getElementById('experiment-details').innerHTML = `
                <div class="alert alert-success">
                    <h5>üéâ –£—Å–ø–µ—à–Ω–æ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç!</h5>
                    <p>–ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç ID: #${data.experiment_id}</p>
                    <p>–í–∞—à–µ—Ç–æ —É—á–µ—Å—Ç–≤–æ –µ –∑–∞–ø–∏—à–∞–Ω–æ. –ú–æ–∂–µ—Ç–µ –¥–∞ –≥–æ –≤–∏–¥–∏—Ç–µ –≤–æ <a href="/my-experiments">–ú–æ–∏ –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏</a></p>
                </div>
            `;
            
            // –ü–æ 3 —Å–µ–∫—É–Ω–¥–∏ —Ä–µ—Å–µ—Ç–∏—Ä–∞—ò –∑–∞ –Ω–æ–≤ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç
            setTimeout(() => {
                resetExperiment();
            }, 5000);
            
        } else {
            alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—à—É–≤–∞—ö–µ: ' + (data.message || '–ù–µ–ø–æ–∑–Ω–∞—Ç–∞ –≥—Ä–µ—à–∫–∞'));
            participateBtn.innerHTML = 'üìù –ó–∞–ø–∏—à–∏ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç';
            participateBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('–ì—Ä–µ—à–∫–∞:', error);
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—à—É–≤–∞—ö–µ –Ω–∞ —É—á–µ—Å—Ç–≤–æ—Ç–æ');
        participateBtn.innerHTML = 'üìù –ó–∞–ø–∏—à–∏ —É—á–µ—Å—Ç–≤–æ –≤–æ –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç';
        participateBtn.disabled = false;
    });
}

function resetExperiment() {
    // –†–µ—Å–µ—Ç–∏—Ä–∞—ò —Å–µ–ª–µ–∫—Ü–∏—ò–∞
    document.getElementById('element1-select').value = '';
    document.getElementById('element2-select').value = '';
    
    // –†–µ—Å–µ—Ç–∏—Ä–∞—ò –ø—Ä–∏–∫–∞–∑
    document.getElementById('element1-display').innerHTML = '<span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 1</span>';
    document.getElementById('element1-display').style.borderColor = '#007bff';
    document.getElementById('element1-display').style.background = '#f8f9fa';
    
    document.getElementById('element2-display').innerHTML = '<span style="color: #666;">–ò–∑–±–µ—Ä–∏<br>–ï–ª–µ–º–µ–Ω—Ç 2</span>';
    document.getElementById('element2-display').style.borderColor = '#007bff';
    document.getElementById('element2-display').style.background = '#f8f9fa';
    
    // –°–∫—Ä–∏—ò —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
    document.getElementById('result-area').style.display = 'none';
    document.getElementById('participate-btn').style.display = 'none';
    document.getElementById('experiment-details').style.display = 'none';
    
    // –†–µ—Å–µ—Ç–∏—Ä–∞—ò –ø–æ–¥–∞—Ç–æ—Ü–∏
    selectedElements = {};
    currentReactionData = null;
    
    // –û–Ω–µ–≤–æ–∑–º–æ–∂–∏ –∫–æ–ø—á–µ –∑–∞ —Ä–µ–∞–∫—Ü–∏—ò–∞
    document.getElementById('react-btn').disabled = true;
}
</script>
{% endblock %}